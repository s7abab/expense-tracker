<template>
  <div class="speed-assistant">
    <v-slide-x-transition>
      <div v-show="isVisible" class="speed-content">
        <!-- Speech Bubble -->
        <div class="speech-bubble">
          <div class="assistant-name">SPEED</div>
          <div class="analysis-text">
            {{ currentMessage }}
          </div>
        </div>
        
        <!-- Speed Avatar -->
        <div class="avatar-container">
          <v-avatar
            :image="currentAvatar"
            size="120"
            class="speed-avatar"
          />
          <v-btn
            icon="mdi-close"
            size="small"
            variant="text"
            class="close-btn"
            color="error"
            @click="hideAssistant"
          />
        </div>
      </div>
    </v-slide-x-transition>
    
    <!-- Toggle button -->
    <v-btn
      v-show="!isVisible"
      color="error"
      class="toggle-btn"
      elevation="4"
      size="large"
      height="60"
      @click="showAssistant"
    >
      <v-avatar :image="currentAvatar" size="42" class="toggle-avatar" />
      <span class="ml-2">ASK SPEED</span>
    </v-btn>
  </div>
</template>

<script setup>
import { ref, watch, computed } from 'vue'

const props = defineProps({
  tasks: {
    type: Array,
    required: true
  }
})

const currentMessage = ref('')
const isVisible = ref(true)

// Avatar URLs for different moods
const avatars = {
  angry: "https://image-cdn.essentiallysports.com/wp-content/uploads/IShowSpeed-4-640x640.png",
  happy: "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRscA_F7YdntUrC2Dkc-kE845pkKkZZT6tnrA&s",
  normal: "https://images-wixmp-ed30a86b8c4ca887773594c2.wixmp.com/f/07ed52f9-65de-4d91-afc1-6d9594f0de81/dgrlexe-c422f5f4-26f5-4cce-a070-13bfb07b4638.png/v1/fill/w_1044,h_766,q_70,strp/i_show_speed__1_by_mrorlandomagicfan200_dgrlexe-pre.jpg?token=eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJ1cm46YXBwOjdlMGQxODg5ODIyNjQzNzNhNWYwZDQxNWVhMGQyNmUwIiwiaXNzIjoidXJuOmFwcDo3ZTBkMTg4OTgyMjY0MzczYTVmMGQ0MTVlYTBkMjZlMCIsIm9iaiI6W1t7ImhlaWdodCI6Ijw9OTE0IiwicGF0aCI6IlwvZlwvMDdlZDUyZjktNjVkZS00ZDkxLWFmYzEtNmQ5NTk0ZjBkZTgxXC9kZ3JsZXhlLWM0MjJmNWY0LTI2ZjUtNGNjZS1hMDcwLTEzYmZiMDdiNDYzOC5wbmciLCJ3aWR0aCI6Ijw9MTI0NiJ9XV0sImF1ZCI6WyJ1cm46c2VydmljZTppbWFnZS5vcGVyYXRpb25zIl19.GBdiBzg385vvRL0tYuF_tzoJ62uLdbom2kMvw_AFPNE",
  sad: "https://www.indiatimes.com/entertainment/bollywood/american-youtuber-ishowspeed-reacts-to-jawans-trailer-calls-it-new-avengers-movie-609009.html"
}

// Determine avatar based on analytics
const currentAvatar = computed(() => {
  const { completionRate, highPriority, total, done } = analytics.value
  
  // Show angry Speed when things are bad
  if (completionRate < 30 || (highPriority > 2 && analytics.value.inProgress === 0)) {
    return avatars.angry
  }
  
  // Show sad Speed when no progress or no tasks
  if (total === 0 || done === 0) {
    return avatars.sad
  }
  
  // Show happy Speed for good progress
  if (completionRate > 70 || analytics.value.done === total) {
    return avatars.happy
  }
  
  // Default to normal Speed
  return avatars.normal
})

// Compute analytics
const analytics = computed(() => {
  const total = props.tasks.length
  const done = props.tasks.filter(t => t.status === 'done').length
  const inProgress = props.tasks.filter(t => t.status === 'inProgress').length
  const highPriority = props.tasks.filter(t => t.priority === 'High').length
  
  return {
    total,
    done,
    inProgress,
    highPriority,
    completionRate: total ? Math.round((done / total) * 100) : 0
  }
})

// Generate different messages based on analytics
const generateMessage = () => {
  const messages = [
    // Angry Speed reactions (when tasks aren't getting done)
    `BRUHHH ${analytics.value.completionRate < 20 ? 
      `YOU ONLY AT ${analytics.value.completionRate}%?! I'M BOUT TO LOSE IT FR FR! ü§¨ GET YO LAZY SELF UP! SEWEY!` : 
      "KEEP GRINDIN' YOU ALMOST THERE! üí™"}`,

    `${analytics.value.highPriority > 3 ? 
      "NAHHHH THIS IS ACTUALLY MAKING ME MAD MAD! ${analytics.value.highPriority} HIGH PRIORITY?! DO SOMETHING RN! ü§¨" : 
      "AIGHT BET, YOU HANDLING THEM PRIORITIES! SUIIIII! üêê"}`,

    // Happy/Excited Speed reactions (for good progress)
    `${analytics.value.done > 3 ? 
      "YESSIR! YOU GOING STUPID WITH IT! ${analytics.value.done} TASKS CLEARED! CRISTIANO RONALDO! SEWEYYYY! ‚öΩÔ∏èüî•" : 
      "MY GRANDMA WORK FASTER THAN THIS BRO! üíÄ"}`,

    // Normal Speed reactions (general updates)
    `${analytics.value.inProgress ? 
      `YOU GOT ${analytics.value.inProgress} TASKS IN THE COOKER! THAT'S WHAT I LIKE TO SEE! WHO'S THE BEST?! SPEED! üèÉ‚Äç‚ôÇÔ∏è` : 
      "BRO REALLY SITTING HERE DOING NOTHING! I CAN'T WITH YOU! üò≠"}`,

    // Classic Speed catchphrases
    `${analytics.value.total === 0 ? 
      "SPEED HERE! AND TODAY... BRO WHERE ARE THE TASKS AT?! ARE YOU SERIOUS RN?! üò§" :
      `${analytics.value.completionRate}% COMPLETE! ${analytics.value.completionRate > 50 ? "SIUUUUUU! üêê" : "WAKE UP WAKE UP! üò°"}`}`,

    // Speed's competitive spirit
    `${analytics.value.done > 0 ? 
      `${analytics.value.done} TASKS DONE! BUT I COULD DO MORE! I'M BETTER THAN YOU! SPEED THE GOAT! üêê` : 
      "0 TASKS?! NAH NAH NAH, YOU'RE ACTUALLY SELLING! I'M DONE! üò§"}`,

    // Speed's signature rage
    `${analytics.value.highPriority > 2 && analytics.value.inProgress === 0 ? 
      "BRO IS YOU DUMB?! HIGH PRIORITY TASKS SITTING THERE! I'M ACTUALLY GETTING TIGHT! ü§¨" : 
      "YOU MOVING LIKE A REAL CHAMPION! SIUUUUUU! ‚öΩÔ∏è"}`,

    // Speed's motivational mode
    `SPEED HERE! ${analytics.value.completionRate < 40 ? 
      "YOU MAKING ME LOOK BAD RN! DO BETTER! üò†" : 
      "YOU'RE HIM! YOU'RE ACTUALLY HIM! üî•"}`,

    // Speed's celebration style
    `${analytics.value.done === analytics.value.total && analytics.value.total > 0 ? 
      "SUIIIII! ALL TASKS CLEARED! CRISTIANO RONALDO! SEWEYYYY! üêê‚öΩÔ∏è" : 
      "WHY YOU NOT FINISHED YET?! YOU PLAYING WITH ME FR! üò§"}`,

    // Add new sad Speed reactions
    `${analytics.value.done === 0 ? 
      "bro... i'm actually sad rn... not a single task done? üò¢ you making speed cry fr fr..." : 
      "KEEP THAT GRIND UP! DON'T MAKE ME SAD AGAIN! üí™"}`,

    `${analytics.value.total === 0 ? 
      "my disappointment is immeasurable... and my day is ruined... WHERE THE TASKS AT?! üò≠" : 
      "AT LEAST YOU GOT SOME TASKS! NOW DO THEM! üò§"}`,

    `${analytics.value.highPriority > 0 && analytics.value.inProgress === 0 ? 
      "you see these priority tasks and doing nothing... why you doing this to me bro... üò¢" : 
      "THAT'S MORE LIKE IT! KEEP WORKING! üî•"}`
  ]
  
  return messages[Math.floor(Math.random() * messages.length)]
}

// Update message every 10 seconds
let messageInterval
onMounted(() => {
  currentMessage.value = generateMessage()
  messageInterval = setInterval(() => {
    currentMessage.value = generateMessage()
  }, 10000)
})

onUnmounted(() => {
  clearInterval(messageInterval)
})

// Update message when tasks change
watch(() => props.tasks, () => {
  currentMessage.value = generateMessage()
}, { deep: true })

const hideAssistant = () => {
  isVisible.value = false
}

const showAssistant = () => {
  isVisible.value = true
  currentMessage.value = generateMessage() // Generate new message when showing
}
</script>

<style lang="scss" scoped>
.speed-assistant {
  position: fixed;
  right: 24px;
  top: 24px;
  z-index: 100;
}

.speed-content {
  position: relative;
  display: flex;
  flex-direction: column;
  align-items: flex-end;
  gap: 8px;
  width: 320px;
}

.speech-bubble {
  position: relative;
  background: rgba(255, 255, 255, 0.98);
  backdrop-filter: blur(12px);
  border: 2px solid rgba(239, 68, 68, 0.2);
  border-radius: 20px;
  padding: 16px;
  width: 100%;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
  margin-bottom: 12px;
  
  // Speech bubble triangle
  &:after {
    content: '';
    position: absolute;
    bottom: -12px;
    right: 60px;
    width: 0;
    height: 0;
    border-left: 12px solid transparent;
    border-right: 12px solid transparent;
    border-top: 12px solid rgba(255, 255, 255, 0.98);
  }
  
  &:before {
    content: '';
    position: absolute;
    bottom: -14px;
    right: 58px;
    width: 0;
    height: 0;
    border-left: 14px solid transparent;
    border-right: 14px solid transparent;
    border-top: 14px solid rgba(239, 68, 68, 0.2);
    z-index: -1;
  }
}

.avatar-container {
  position: relative;
  margin-right: 24px;
}

.speed-avatar {
  border: 3px solid #ef4444;
  box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
  transition: all 0.3s ease;
  
  &:hover {
    transform: scale(1.05);
    box-shadow: 0 6px 16px rgba(239, 68, 68, 0.4);
  }
}

.close-btn {
  position: absolute;
  top: -8px;
  right: -8px;
  background: white !important;
  border: 2px solid #ef4444 !important;
  opacity: 0.9;
  
  &:hover {
    opacity: 1;
    transform: scale(1.1);
  }
}

.toggle-btn {
  border-radius: 16px;
  padding: 8px 20px;
  font-weight: 600;
  letter-spacing: 0.5px;
  border: 2px solid rgba(239, 68, 68, 0.2);
  
  &:hover {
    .toggle-avatar {
      transform: scale(1.1);
    }
  }
}

.toggle-avatar {
  transition: transform 0.2s ease;
}

.assistant-name {
  font-size: 18px;
  font-weight: 800;
  color: #ef4444;
  margin-bottom: 8px;
  text-transform: uppercase;
  text-align: center;
}

.analysis-text {
  font-size: 16px;
  line-height: 1.5;
  color: #4b5563;
  text-align: center;
  font-weight: 500;
}

@media (max-width: 768px) {
  .speed-assistant {
    right: 16px;
    top: 16px;
  }

  .speed-content {
    width: 300px;
  }

  .toggle-btn {
    padding: 6px 16px;
    
    .v-avatar {
      size: 36px;
    }
  }
}
</style> 